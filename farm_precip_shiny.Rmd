---
title: "Three Oaks Farms Precipitation"
runtime: shiny
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, echo=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(forcats)
library(knitr)
library(shiny)
library(rsconnect)
```

```{r, message=FALSE, echo=FALSE}
precip_data <- read_csv("farm_precip_3march2019.csv")
```

```{r, echo=FALSE}
# Clean data
precip_clean <- precip_data %>% 
  mutate(date = mdy(date)) %>% 
  mutate(month = month(date, label = TRUE)) %>%
  mutate(year = year(date)) %>%
  mutate(precip_cat = cut(precip, breaks = c(0,.5,1,2,5), 
                               labels = c("<0.5", "0.5 - 0.99", 
                                             "1 - 1.99", "2+"), 
                               right = FALSE)) %>% 
  group_by(month)

summary_data <- precip_data %>%
    mutate(date = mdy(date)) %>% 
    mutate(month = month(date, label = TRUE)) %>%
    mutate(year = year(date)) %>%
    group_by(year, month) %>% 
    summarise(sum(precip), n(), mean(precip), median(precip), max(precip)) %>% 
    rename(Month = month, `Total Precip` = `sum(precip)`, `Precip Events` = `n()`, 
           `Mean Precip Event` = `mean(precip)`, `Median Precip Event` = `median(precip)`, 
           `Max Precip Event` = `max(precip)`) %>% 
    ungroup()
```


```{r, echo=FALSE}
# Define UI for app that draws a histogram ----
ui <- fluidPage(

  # App title ----
  titlePanel("McPherson, KS, USA"),

  # Sidebar layout with input and output definitions ----
  sidebarLayout(

    # Sidebar panel for inputs ----
    sidebarPanel(

      # Input: Slider for the number of bins ----
      selectInput(inputId = "year",
                  label = "Year:",
                  choices = c(2013, 2014, 2015, 2016, 2017, 2018, 2019))

    ),

    # Main panel for displaying outputs ----
    mainPanel(

      # Output: Histogram ----
      plotOutput(outputId = "precip_bar"),
      
      tableOutput(outputId = "precip_table")

    )
  )
)
```


```{r, echo=FALSE}
server <- function(input, output) {

# 1. Select among columns
filtered_data <- reactive({
    precip_clean %>%
    filter(year == input$year)
  
}) 

output$precip_bar <- renderPlot({
ggplot(filtered_data()) +
    geom_col(aes(x = month, y = precip, fill = precip_cat), 
             color = "black") +
    labs(x = "", y = "Precipitation Total (inches)", fill = "Precipitation category",
         title = input$year) +
    theme_minimal() +
    theme(axis.line = element_line(size = 1.2), 
          panel.grid.major.y = element_line(size = 0.5, color = "black"), 
          panel.grid.major.x = element_blank(), 
          axis.text.x = element_text(size = 14, color = "black", angle = 15), 
          axis.text.y = element_text(size = 14, color = "black"), 
          title = element_text(size = 17, color = "black"), 
          legend.text = element_text(size = 15)) +
    scale_fill_brewer(palette = "Blues")
})


table_data <- reactive({
    summary_data %>%
    filter(year == input$year) %>% 
    select(-year)
})

output$precip_table <- renderTable({
  head(table_data(), n = 12)
})

}
```


```{r, echo=FALSE}
shinyApp(ui, server)
```